name: Publish Java and Kotlin Packages to Maven Central

on:
  workflow_dispatch:
    inputs:
      release-type:
        description: 'Release type (snapshot or release)'
        required: true
        default: 'snapshot'
        type: choice
        options:
          - snapshot
          - release
      java-version:
        description: 'Publish Java packages'
        required: true
        default: 'true'
        type: boolean
      kotlin-version:
        description: 'Publish Kotlin packages'
        required: true
        default: 'true'
        type: boolean

jobs:
  publish-java:
    if: inputs.java-version == 'true' || inputs.java-version == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'

      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          echo "$GPG_PRIVATE_KEY" | base64 --decode | gpg --batch --import
          gpg --list-secret-keys --keyid-format LONG

      - name: Configure Maven settings
        run: |
          mkdir -p ~/.m2
          cat <<EOF > ~/.m2/settings.xml
          <settings>
            <servers>
              <server>
                <id>ossrh</id>
                <username>${{ secrets.OSSRH_USERNAME }}</username>
                <password>${{ secrets.OSSRH_PASSWORD }}</password>
              </server>
            </servers>
            <profiles>
              <profile>
                <id>ossrh</id>
                <activation>
                  <activeByDefault>true</activeByDefault>
                </activation>
                <properties>
                  <gpg.executable>gpg</gpg.executable>
                  <gpg.passphrase>${{ secrets.GPG_PASSPHRASE }}</gpg.passphrase>
                </properties>
              </profile>
            </profiles>
          </settings>
          EOF

      - name: Publish Java Core Package
        working-directory: packages/java/openlibx402-core
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          if [ "${{ inputs.release-type }}" == "release" ]; then
            mvn clean deploy -P release -DskipTests
          else
            mvn clean deploy -DskipTests
          fi

      - name: Publish Java Client Package
        working-directory: packages/java/openlibx402-client
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          if [ "${{ inputs.release-type }}" == "release" ]; then
            mvn clean deploy -P release -DskipTests
          else
            mvn clean deploy -DskipTests
          fi

      - name: Summary
        run: |
          echo "### Java Packages Published ✅" >> $GITHUB_STEP_SUMMARY
          echo "- openlibx402-core: 0.1.0" >> $GITHUB_STEP_SUMMARY
          echo "- openlibx402-client: 0.1.0" >> $GITHUB_STEP_SUMMARY
          echo "- Release type: ${{ inputs.release-type }}" >> $GITHUB_STEP_SUMMARY

  publish-kotlin:
    if: inputs.kotlin-version == 'true' || inputs.kotlin-version == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          echo "$GPG_PRIVATE_KEY" | base64 --decode | gpg --batch --import
          gpg --list-secret-keys --keyid-format LONG

      - name: Grant execute permission for gradlew
        working-directory: packages/kotlin
        run: chmod +x gradlew

      - name: Create gradle.properties
        working-directory: packages/kotlin
        run: |
          cat <<EOF > gradle.properties
          ossrhUsername=${{ secrets.OSSRH_USERNAME }}
          ossrhPassword=${{ secrets.OSSRH_PASSWORD }}
          signing.keyId=${{ secrets.GPG_KEY_ID }}
          signing.password=${{ secrets.GPG_PASSPHRASE }}
          signing.secretKeyRingFile=$HOME/.gnupg/secring.gpg
          EOF

      - name: Export GPG key ring
        run: |
          gpg --export-secret-keys -o $HOME/.gnupg/secring.gpg

      - name: Publish Kotlin Packages
        working-directory: packages/kotlin
        env:
          ORG_GRADLE_PROJECT_ossrhUsername: ${{ secrets.OSSRH_USERNAME }}
          ORG_GRADLE_PROJECT_ossrhPassword: ${{ secrets.OSSRH_PASSWORD }}
          ORG_GRADLE_PROJECT_signingKey: ${{ secrets.GPG_PRIVATE_KEY }}
          ORG_GRADLE_PROJECT_signingPassword: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          ./gradlew clean build -x test
          ./gradlew publish --no-daemon --stacktrace

      - name: Summary
        run: |
          echo "### Kotlin Packages Published ✅" >> $GITHUB_STEP_SUMMARY
          echo "- openlibx402-core (Kotlin): 0.1.0" >> $GITHUB_STEP_SUMMARY
          echo "- openlibx402-client (Kotlin): 0.1.0" >> $GITHUB_STEP_SUMMARY
          echo "- Release type: ${{ inputs.release-type }}" >> $GITHUB_STEP_SUMMARY

  verify-publication:
    needs: [publish-java, publish-kotlin]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Check Publication Status
        run: |
          echo "## Publication Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.publish-java.result }}" == "success" ]; then
            echo "✅ Java packages published successfully" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.publish-java.result }}" == "skipped" ]; then
            echo "⏭️ Java packages skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Java packages failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.publish-kotlin.result }}" == "success" ]; then
            echo "✅ Kotlin packages published successfully" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.publish-kotlin.result }}" == "skipped" ]; then
            echo "⏭️ Kotlin packages skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Kotlin packages failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.release-type }}" == "release" ]; then
            echo "1. Log in to https://oss.sonatype.org/" >> $GITHUB_STEP_SUMMARY
            echo "2. Go to 'Staging Repositories'" >> $GITHUB_STEP_SUMMARY
            echo "3. Find repository orgopenlibx402-XXXX" >> $GITHUB_STEP_SUMMARY
            echo "4. Click 'Close' and wait for validation" >> $GITHUB_STEP_SUMMARY
            echo "5. Click 'Release' to publish to Maven Central" >> $GITHUB_STEP_SUMMARY
            echo "6. Packages will be available in ~2 hours at:" >> $GITHUB_STEP_SUMMARY
            echo "   - https://search.maven.org/search?q=g:org.openlibx402" >> $GITHUB_STEP_SUMMARY
          else
            echo "Snapshot packages are available immediately at:" >> $GITHUB_STEP_SUMMARY
            echo "- https://oss.sonatype.org/content/repositories/snapshots/org/openlibx402/" >> $GITHUB_STEP_SUMMARY
          fi
